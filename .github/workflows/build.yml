name: build
on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  VAULT_ADDR: https://hcvault.app.corpintra.net/
  VAULT_NAMESPACE: Action-Runners
  VAULT_ROLE: garm-operator

jobs:
  build:
    name: lint and test
    runs-on: [ road-runner, medium ] # could run on a k8s pod in the future
    steps:
      - name: setup vault
        uses: hashicorp/vault-action@v2.6.0
        with:
          method: jwt
          url: ${{ env.VAULT_ADDR }}
          namespace: ${{ env.VAULT_NAMESPACE }}
          role: ${{ env.VAULT_ROLE }}
          exportToken: true
          secrets: |
            secrets/data/road-runner-technical-user harbor_password | HARBOR_PASSWORD ;
            secrets/data/road-runner-technical-user harbor_username | HARBOR_USERNAME ;
            secrets/data/kubeconfigs c51p171 | KUBECONFIG ;

      - uses: actions/checkout@v3

      - name: Login to harbor
        uses: docker/login-action@v2
        with:
          registry: registry-emea.app.corpintra.net
          username: ${{ env.HARBOR_USERNAME }}
          password: ${{ env.HARBOR_PASSWORD }}

      - name: Docker meta
        id: meta-operator-image
        uses: docker/metadata-action@v4
        with:
          images: registry-emea.app.corpintra.net/roadrunner/garm-operator

      - name: build and push operator-image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: Dockerfile
          tags: ${{steps.meta-operator-image.outputs.tags}}
          push: true

      - uses: actions/setup-go@v4
        with:
          go-version: '1.20'
          cache: false
      - name: make lint
        run: make golangci-lint && GOLANGCI_LINT_EXTRA_ARGS=--timeout=1h make lint
      - name: make test
        run: make test
